# システムアーキテクチャ

政府会議ウォッチャーの技術仕様とシステム設計

---

## 🏗️ 全体構成

```
┌─────────────────────────────────────────────────────────┐
│                        ユーザー                          │
│         （メール受信 / Webアプリ / API）                  │
└───────────────────┬─────────────────────────────────────┘
                    │
                    │ HTTPS
                    ▼
┌─────────────────────────────────────────────────────────┐
│              Google Apps Script (GAS)                   │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐        │
│  │dailyCheck  │  │   Webapp   │  │ Security   │        │
│  │   All      │  │            │  │  Monitor   │        │
│  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘        │
│        │                │                │               │
│  ┌─────┴────────────────┴────────────────┴──────┐       │
│  │         共通機能・ユーティリティ              │       │
│  │  - メール配信   - Archive                    │       │
│  │  - 要約生成     - 状態管理                   │       │
│  └──────────────────────────────────────────────┘       │
└───────────┬─────────────────────────┬───────────────────┘
            │                         │
            │ HTTPS                   │ HTTPS
            ▼                         ▼
┌──────────────────────┐  ┌────────────────────────┐
│    VPS (Docker)      │  │    Gemini API          │
│  ┌────────────────┐  │  │                        │
│  │    Fetcher     │  │  │  gemini-2.5-flash     │
│  │  (Playwright)  │  │  │                        │
│  └────────────────┘  │  │  - 要約生成            │
│  ┌────────────────┐  │  │  - キーワード抽出      │
│  │      OCR       │  │  │  - 文脈解析            │
│  │  (Tesseract)   │  │  │                        │
│  └────────────────┘  │  └────────────────────────┘
│  ┌────────────────┐  │
│  │      ASR       │  │
│  │   (yt-dlp)     │  │
│  └────────────────┘  │
└──────────────────────┘
```

---

## 📊 データフロー

### 1. 日次監視フロー

```
毎日0時（トリガー）
  ↓
dailyCheckAll() 実行
  ↓
全監視対象会議をループ
  ↓
  ┌──────────────────────────┐
  │ 1. インデックスページ取得 │ ← VPS Fetcher
  └───────────┬──────────────┘
              │
              ▼
  ┌──────────────────────────┐
  │ 2. 会議ページ一覧を抽出   │
  └───────────┬──────────────┘
              │
              ▼
  ┌──────────────────────────┐
  │ 3. 新着会議を検知         │ ← State管理
  └───────────┬──────────────┘
              │
              ▼（新着あり）
  ┌──────────────────────────┐
  │ 4. 会議ページを取得       │ ← VPS Fetcher
  └───────────┬──────────────┘
              │
              ▼
  ┌──────────────────────────┐
  │ 5. PDF OCR               │ ← VPS OCR
  │  - 議事次第               │
  │  - 委員名簿               │
  └───────────┬──────────────┘
              │
              ▼
  ┌──────────────────────────┐
  │ 6. YouTube字幕取得        │ ← VPS ASR
  └───────────┬──────────────┘
              │
              ▼
  ┌──────────────────────────┐
  │ 7. Gemini要約生成         │ ← Gemini API
  └───────────┬──────────────┘
              │
              ▼
  ┌──────────────────────────┐
  │ 8. メール配信             │ → Gmail
  └───────────┬──────────────┘
              │
              ▼
  ┌──────────────────────────┐
  │ 9. Archive保存            │ → Googleシート
  └───────────┬──────────────┘
              │
              ▼
  ┌──────────────────────────┐
  │ 10. 状態更新              │ → Script Properties
  └──────────────────────────┘
```

### 2. ユーザー操作フロー

```
メールの「配信停止」リンクをクリック
  ↓
Webapp: doGet() 実行
  ↓
  ┌──────────────────────────┐
  │ 1. トークン検証           │ ← HMAC検証
  └───────────┬──────────────┘
              │
              ▼
  ┌──────────────────────────┐
  │ 2. Rate Limit チェック    │ ← CacheService
  └───────────┬──────────────┘
              │
              ▼（OK）
  ┌──────────────────────────┐
  │ 3. 購読状態を更新         │ → Googleシート
  └───────────┬──────────────┘
              │
              ▼
  ┌──────────────────────────┐
  │ 4. セキュリティログ記録   │ → Logger
  └───────────┬──────────────┘
              │
              ▼
  ┌──────────────────────────┐
  │ 5. 確認画面を表示         │ → HTML
  └──────────────────────────┘
```

---

## 🗄️ データ管理

### 1. Script Properties（設定値）

```javascript
{
  "GEMINI_API_KEY": "AIzaSy...",
  "VPS_FETCH_BASE": "https://fetch.klammer.co.jp",
  "VPS_FETCH_TOKEN": "e73b1b...",
  "ASR_TOKEN": "...",
  "state": "{...}",  // 会議の状態
  "security_monitor_last_result": "{...}"
}
```

### 2. Googleシート（購読者管理）

```
シート: Recipients

| email              | status      | sources | token    | created_at | updated_at | notes |
|--------------------|-------------|---------|----------|------------|------------|-------|
| user@example.com   | active      | *       | abc123   | 2025-11-01 | 2025-11-12 |       |
| user2@example.com  | unsubscribed| 1,3,5   | def456   | 2025-11-05 | 2025-11-10 |       |
```

### 3. Googleシート（Archive）

```
シート: Archive

| source_id | source_name | agency | meeting_id | meeting_date | title | url | youtube_url | summary | ... |
|-----------|-------------|--------|------------|--------------|-------|-----|-------------|---------|-----|
| 1         | 同時市場... | 経産省  | 20         | 2025-11-10   | ...   | ... | ...         | ...     | ... |
```

### 4. CacheService（一時データ）

```javascript
// Rate Limiting
"rate_user@example.com_unsubscribe": "5"  // 1時間保持

// セキュリティ監視
"monitor_total_requests": "150"
"monitor_error_requests": "5"
"monitor_rate_limit_hits": "2"
"monitor_gemini_calls": "20"

// アラート抑制
"alert_sent_user@example.com_rate_limit_exceeded": "1"
```

---

## 🔧 主要コンポーネント

### 1. コード.gs（メインロジック）

```javascript
// 主要関数
dailyCheckAll()              // 日次監視処理
scrapeMeetingPage_()         // 会議ページのスクレイピング
extractPdfTextViaVps_()      // PDF OCR
fetchSubsViaVps_()           // YouTube字幕取得
summarizeMeeting_()          // Gemini要約生成
sendToRecipients_()          // メール送信
saveToArchive_()             // Archive保存
```

**役割**:
- 会議監視のメインロジック
- VPS・Gemini APIとの連携
- メール配信
- データ永続化

### 2. webapp.gs（Webアプリ）

```javascript
// 主要関数
doGet()                      // GETリクエスト処理
doPost()                     // POSTリクエスト処理
showPublicSources_()         // 会議一覧ページ
checkRateLimit_()            // Rate Limiting
logSecurityEvent_()          // セキュリティログ
```

**役割**:
- ユーザー向けWebインターフェース
- 購読管理（配信停止・再登録）
- セキュリティ制御

### 3. security_monitor.gs（セキュリティ監視）

```javascript
// 主要関数
monitorSecurityStatus()      // 1時間ごとに自動実行
checkErrorRate_()            // エラー率監視
checkAccessPatterns_()       // 異常アクセス検知
checkApiUsage_()             // API使用量監視
checkVpsHealth_()            // VPS接続監視
sendSecurityReport_()        // 管理者へ通知
```

**役割**:
- システム監視
- 異常検知
- 管理者へのアラート

### 4. group_processing.gs（スケーラビリティ）

```javascript
// 主要関数
dailyCheckByGroup()          // グループ単位の処理
sendConsolidatedDailyReport() // 統合レポート
setupGroupTriggers()         // トリガー設定
```

**役割**:
- 100会議対応のグループ分割処理
- 実行時間制限（6分）の回避

---

## 🔐 セキュリティアーキテクチャ

### 多層防御

```
Layer 1: Rate Limiting
  └─ 10回/時間の制限でbot攻撃を防止

Layer 2: トークン認証
  └─ HMACによる署名検証

Layer 3: 入力値検証
  └─ XSS対策のパターンマッチング

Layer 4: セキュリティログ
  └─ すべての重要アクションを記録

Layer 5: 異常検知
  └─ リアルタイムでパターン分析

Layer 6: 定期監視
  └─ 1時間ごとのヘルスチェック
```

### 認証フロー

```
ユーザー操作（配信停止等）
  ↓
1. メールアドレス + トークンを受信
  ↓
2. トークン検証
   token == HMAC-SHA256(email, SECRET)
  ↓（OK）
3. Rate Limitチェック
   10回/時間を超えていないか
  ↓（OK）
4. 処理実行
  ↓
5. ログ記録
```

---

## 🌐 VPSアーキテクチャ

### Docker構成

```
VPS
├── fetcher (Port 3001)
│   └── Playwright + Node.js
│       - Basic認証
│       - fail2ban
│
├── ocr (Port 3002)
│   └── Tesseract + Python
│       - PDF → テキスト変換
│       - 日本語対応
│
└── asr (Port 3003)
    └── yt-dlp + Python
        - YouTube字幕取得
        - 自動字幕/手動字幕
```

### エンドポイント

```
GET  /fetcher/crawl?url=<URL>
  → HTML取得
  
POST /asr/pdf
  { "url": "<PDF_URL>", "lang": "jpn" }
  → { "text": "...", "pages": 10 }

POST /asr/youtube-subs
  { "url": "<YOUTUBE_URL>" }
  → { "transcript": "..." }
```

---

## 📈 スケーラビリティ

### 現在（8会議）

```
実行時間: 約2分
メール: 約50通/日
問題なし ✅
```

### 20会議

```
実行時間: 約3分
メール: 約100通/日
現状のまま対応可能 ✅
```

### 50会議（2グループ分割）

```
グループ1（0時）: 25会議 = 約2.5分
グループ2（1時）: 25会議 = 約2.5分
メール: 約250通/日
Google Workspace必須 ⚠️
```

### 100会議（5グループ分割）

```
グループ1（0時）: 20会議 = 約2分
グループ2（1時）: 20会議 = 約2分
グループ3（2時）: 20会議 = 約2分
グループ4（3時）: 20会議 = 約2分
グループ5（4時）: 20会議 = 約2分
統合レポート（6時）: 約30秒
メール: 約500通/日
Google Workspace必須 ⚠️
```

---

## 🔄 障害対応

### 自動リトライ

```javascript
// VPS接続失敗時
fetchViaVps_() が失敗
  ↓
直接UrlFetchApp.fetchにフォールバック
  ↓
それも失敗 → エラーログ記録 → 次の会議へ
```

### 監視・アラート

```
エラー率 > 30%
  ↓
管理者にメール送信

VPS接続失敗
  ↓
即座にメール送信

Rate Limit違反 > 5回
  ↓
異常アクセスとして通知
```

---

## 📝 今後の技術課題

### Phase 2（課金対応）
- Stripe Webhook処理の実装
- ユーザー認証の追加
- データベース構造の最適化

### Phase 3（プレミアム機能）
- キーワード検索のパフォーマンス最適化
- Geminiプロンプトの改善
- カスタムテンプレートエンジン

### Phase 4（スケール）
- BigQueryへのログ移行
- Cloud Functionsの活用検討
- マイクロサービス化の検討

---

**最終更新**: 2025-11-12
